let TrackInfo=()=>{$.ajax({url:'http://janus.shoutca.st:8972/stats',data:{sid:1,json:1},dataType:'jsonp'}).done((data)=>{let currentSong=clearStr(data.songtitle),titleMarquee=document.querySelector('#title .marquee p'),artistMarquee=document.querySelector('#artist .marquee p');document.getElementById('song').setAttribute("value",currentSong[0]+"\\"+currentSong[1]);if($("#title .marquee p").text().localeCompare(currentSong[1])!=0)lastFm(currentSong[0],currentSong[1]);titleMarquee.textContent=currentSong[1];artistMarquee.textContent=currentSong[0];document.getElementById("listeners").textContent=data.currentlisteners;if(titleMarquee.clientWidth>=document.getElementById('title').clientWidth-20)titleMarquee.classList.add("animateMarquee");else titleMarquee.classList.remove("animateMarquee");if(artistMarquee.clientWidth>=document.getElementById('artist').clientWidth-20)artistMarquee.classList.add("animateMarquee");else artistMarquee.classList.remove("animateMarquee");recentTracks()}).fail((e)=>{alert(e+" Datos de la radio no encontrados");clearInterval(runStats)})},lastFm=(artist,track)=>{if(artist.localeCompare("Desconocido")!=0){$.ajax({url:'http://ws.audioscrobbler.com/2.0/',data:{method:'track.getInfo',api_key:'98717496b44bab3367cac9903dbce3e9',artist:artist,track:track,format:'json'},dataType:'jsonp'}).done((data)=>{if(data.error===6||(typeof data.track.album==="undefined")||data.track.album.image[3]['#text']===""){song=document.getElementById('song').getAttribute("value").split("\\");iTunes(song[1],song[0])}
else $('#cover').attr('src',data.track.album.image[3]['#text'])}).fail((jqXHR,textStatus)=>{if(jqXHR.status==403)$('#cover').attr('src',defaultCover())})}else $('#cover').attr('src',defaultCover())},iTunes=(artist,track)=>{if(artist.localeCompare("Desconocido")!=0){$.ajax({url:'http://itunes.apple.com/search',data:{term:artist+' '+track,media:'music'},dataType:'jsonp',}).done((json)=>{if(json.resultCount===0)$('#cover').attr('src',defaultCover());else $('#cover').attr('src',json.results[0].artworkUrl100.replace("100x100","300x300"))}).fail((jqXHR,textStatus)=>{if(jqXHR.status==403){$('#cover').attr('src',defaultCover())}})}else $('#cover').attr('src',defaultCover())},initDPlayer=()=>{RAplayer=document.getElementById('player'),playBtn=document.getElementById('playBtn'),muteBtn=document.getElementById('muteBtn');playBtn.addEventListener("click",()=>{if(playBtn.getAttribute("value")=="play")pauseP();else playP()});muteBtn.addEventListener("click",()=>{if(muteBtn.getAttribute("value")=="sound"){RAplayer.muted=!0;muteBtn.setAttribute("value","mute");muteBtn.classList.remove("icon-volume");muteBtn.classList.add("icon-mute")}else{RAplayer.muted=!1;muteBtn.setAttribute("value","sound");muteBtn.classList.remove("icon-mute");muteBtn.classList.add("icon-volume")}});RAplayer.volume=document.getElementById("volume").value;document.getElementById("volume").onchange=(e)=>{RAplayer.volume=e.target.value}
document.getElementById("op-playerBtn").addEventListener("click",()=>{if(document.getElementById("op-player").checked)stopA();else startA()});runStats=setInterval(TrackInfo,12000)},playP=()=>{RAplayer.load();RAplayer.play();playBtn.setAttribute("value","play");playBtn.classList.remove("icon-play");playBtn.classList.add("icon-stop");TrackInfo();runStats=setInterval(TrackInfo,12000)},pauseP=()=>{RAplayer.pause();playBtn.setAttribute("value","stop");playBtn.classList.remove("icon-stop");playBtn.classList.add("icon-play");clearInterval(runStats)},initVisualizer=()=>{try{var ctxt=window.AudioContext||window.webkitAudioContext;if(ctxt){context=new ctxt()}}catch(e){console.log(e)}
analyser=context.createAnalyser();canvas=document.getElementById('frequency_render');ctx=canvas.getContext('2d');ctx.strokeStyle="#bf0411";source=context.createMediaElementSource(RAplayer);source.connect(analyser);analyser.connect(context.destination);frameLooper()},frameLooper=()=>{requestId=undefined;fbc_array=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(fbc_array);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.beginPath();ctx.moveTo(canvas.width,canvas.height/2);for(var i=0;i<Math.floor(fbc_array.length/3.2);i++){bar_x=canvas.width-i;bar_width=1;if(i%2==0)bar_height=(-(fbc_array[i]/3.5))+canvas.height/2;else bar_height=(fbc_array[i]/3.5)+canvas.height/2;ctx.lineTo(bar_x,bar_height)}
ctx.stroke();startA()},recentTracks=()=>{fetch("https://janus.shoutca.st/recentfeed/kuronegai/json/").then(res=>res.json()).then(data=>{for(let i=1;i<5;i++){let track=clearStr(data.items[i].title);document.getElementById("title"+i).textContent=track[1];document.getElementById("artist"+i).textContent=track[0];if(data.items[i].enclosure.url.indexOf("nocover.png")>0)document.getElementById("cover"+i).setAttribute("src","https://2.bp.blogspot.com/-thb9iU60J7M/W4TKqJR2rQI/AAAAAAAAAVQ/WrvAIx7N5sQh1maEq2x9I0o9L5PjnahQwCLcBGAs/s1600/no_cover_60x60.jpg");else document.getElementById("cover"+i).setAttribute("src",data.items[i].enclosure.url)}}).catch(error=>alert(error+" Temas Recientes No Cargados"))},clearStr=(str)=>{if(str.length>1){str=str.replace(" - "," \\ ").split("\\");if(str[1].charAt(0)===' ')str[1]=str[1].substr(1);if(str[0].charAt(str[0].length-1)===' ')str[0]=str[0].slice(0,-1)}else{let temp=str[0];str[1]=temp;str[0]="Desconocido"}
return str},startA=()=>{if(!requestId)requestId=window.requestAnimationFrame(frameLooper)},stopA=()=>{if(requestId){window.cancelAnimationFrame(requestId);requestId=undefined}}
defaultCover=()=>"https://2.bp.blogspot.com/-yUnXHoN2gao/W3_YII0WO5I/AAAAAAAAAU8/G5nDTAPyF4c02WL_XEy33j6oYPuXBsfFACPcBGAYYCw/s1600/no_cover.jpg"
